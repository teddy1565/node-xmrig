# node-xmrig 跨平台兼容性報告

## 🔍 **修復的問題**

### 1. **Native Module 技術棧修正**
- ✅ **移除問題**：硬編碼 v8 API 引用
- ✅ **改為**：純 Node-API/N-API 實現
- ✅ **優勢**：跨版本二進制兼容性 (ABI 穩定)

### 2. **依賴管理修復**
- ✅ **修復前**：`'<!(node -p "require(\'node-addon-api\').gyp")'`
- ✅ **修復後**：`'node-addon-api'` + 正確的 include 路徑
- ✅ **結果**：正確的依賴引用和編譯

### 3. **架構感知配置**
- ✅ **動態檢測**：根據 OS/架構自動調整編譯參數
- ✅ **平台特定**：Windows/Linux/macOS 專屬優化
- ✅ **架構支持**：x64、arm64、x86

## 🛠️ **平台構建指令**

### **Windows (x64)**
```bash
# 安裝 Visual Studio Build Tools 和 CMake
# 然後：
npm run rebuild:win
```

### **Linux (x64)**
```bash
# 安裝系統依賴
sudo apt-get install build-essential python3-dev cmake

npm run rebuild:linux
```

### **macOS (x64/Apple Silicon)**
```bash
# 安裝 CMake
brew install cmake

npm run rebuild:mac
```

### **ARM 架構**
```bash
# ARM64 (Apple Silicon, Linux ARM)
npm run rebuild:arm

# x86 (32-bit) - 較少使用
npm run rebuild:x86
```

## ⚠️ **需要注意的問題**

### **Windows 環境專有問題**
1. **DLL 依賴缺失**
   - 解決方案：使用靜態鏈接
   - 檢查：`dumpbin /dependents build/Release/XMRig.node`

2. **win_delay_load_hook 標記**
   - 解決方案：正確的 link flags 設置
   - 已修復：在 binding.gyp 中配置

### **跨平台編譯問題**
1. **編譯器差異**
   - Windows: MSVC
   - Linux: GCC/Clang  
   - macOS: Clang (Xcode)

2. **系統庫依賴**
   - Linux: `-lpthread`, `-ldl`
   - macOS: Framework 依賴
   - Windows: 靜態鏈接

## 📊 **兼容性矩陣**

| 平台 | 架構 | Node.js | 狀態 | 測試建議 |
|------|------|---------|------|----------|
| Windows 10/11 | x64 | 18, 20, 22 | ✅ 應該可用 | 測試 DLL 依賴 |
| macOS 12+ | x64 | 18, 20, 22 | ✅ 應該可用 | 測試 Apple Silicon |
| macOS 12+ | arm64 | 18, 20, 22 | ✅ 應該可用 | 測試 M1/M2 |
| Ubuntu 20.04+ | x64 | 18, 20, 22 | ✅ 應該可用 | 測試系統庫 |
| Ubuntu 20.04+ | arm64 | 18, 20, 22 | ✅ 應該可用 | 測試 Raspberry Pi |
| CentOS 8+ | x64 | 18, 20, 22 | ✅ 應該可用 | 測試企業環境 |

## 🎯 **測試建議**

### **本地測試流程**
1. **清理**：`npm run clean`
2. **構建**：各平台專屬指令
3. **檢查**：`node -e "console.log(require('./index.js'))"`
4. **運行示例**：`npm run example:basic`

### **自動化測試**
- 可以考慮在每個平台創建小型測試腳本
- 驗證基本功能：創建實例、配置驗證
- 不需要實際挖礦，僅測試模組加載

## 💡 **Electron 支持**

如果後續需要支持 Electron：
- 需要額外的 `electron-rebuild` 步驟
- ABI 版本與 Node.js 不同
- 需要：`node-gyp rebuild --target=version --arch=arch --dist-url=https://electronjs.org/headers`

## 🔄 **持續集成替代方案**

雖然移除了 GitHub Actions，但可以：
1. 創建各平台的構建腳本
2. 使用本地 CI 工具 (Jenkins, GitLab CI 私人 runner)
3. Docker 容器化各平台測試

## ✅ **結論**

修復後的 node-xmrig 應該能在以下環境正常工作：
- Windows 10/11 (x64)
- macOS 12+ (x64, arm64) 
- Linux (x64, arm64)

主要技術改進：
1. 使用 Node-API 確保 ABI 穩定
2. 動態平台檢測和配置
3. 移除硬編碼路徑和依賴
4. 平台特定的編譯優化