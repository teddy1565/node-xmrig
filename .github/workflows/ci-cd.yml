name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  # åŸºç¤Žæ¸¬è©¦å’Œç·¨è­¯é©—è­‰
  test-and-build:
    name: Test on ${{ matrix.os }} - Node.js ${{ matrix.node-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # æ ¸å¿ƒæ¸¬è©¦çµ„åˆï¼ˆæ¯å€‹å¹³å°é¸ä¸€å€‹ç©©å®šç‰ˆæœ¬ï¼‰
          - os: ubuntu-latest
            node-version: '20.x'
          - os: windows-latest
            node-version: '20.x'
          - os: macos-latest
            node-version: '20.x'
          - os: macos-latest
            node-version: '22.x'
            arch: 'arm64'

    env:
      NODE_VERSION: ${{ matrix.node-version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: |
        npm ci --prefer-offline

    - name: Display system info
      run: |
        echo "=== System Information ==="
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        echo "OS: ${{ matrix.os }}"
        uname -a || echo "OS info not available"
        echo "=== Python Check ==="
        python3 --version 2>/dev/null || echo "Python not available"

    - name: Clean build artifacts
      run: |
        npm run clean || true
        rm -rf build/ || true
        echo "Build artifacts cleaned"

    - name: Try to build (graceful failure)
      id: build
      run: |
        echo "=== Attempting Build ==="
        set -e
        npm run build
        echo "Build successful"
      continue-on-error: true

    - name: Build status check
      run: |
        if [ "${{ steps.build.outcome }}" = "failure" ]; then
          echo "âš ï¸ Build failed on ${{ matrix.os }}, but continuing tests..."
        else
          echo "âœ… Build successful on ${{ matrix.os }}"
        fi

    - name: Test module functionality
      run: |
        echo "=== Testing Module Functionality ==="
        node -e "
        try {
          console.log('Loading module...');
          const XMRig = require('./index.js');
          
          console.log('Testing basic API...');
          console.log('Version:', XMRig.getVersion());
          console.log('Algorithms:', XMRig.getSupportedAlgorithms().length);
          console.log('Pools:', XMRig.getRecommendedPools().length);
          
          console.log('Testing miner creation...');
          const config = {
            pool: {
              url: 'test.pool.com:5555',
              user: 'test_wallet_address_123456789',
              pass: 'x'
            },
            cpu: {
              threads: 2
            }
          };
          
          const miner = XMRig.createMiner(config);
          console.log('Miner created successfully');
          
          // Test all API methods exist
          const methods = ['start', 'stop', 'getStats', 'getStatus'];
          let missing = [];
          methods.forEach(method => {
            if (typeof miner[method] !== 'function') {
              missing.push(method);
            }
          });
          
          if (missing.length > 0) {
            console.log('Missing methods:', missing);
            throw new Error('Some methods are missing');
          }
          
          console.log('âœ… All method tests passed');
          
          // Test event system if available
          try {
            miner.on('test', () => {});
            miner.emit('test');
            console.log('âœ… Event system working');
          } catch (e) {
            console.log('âš ï¸ Event system issue:', e.message);
          }
          
          console.log('âœ… All module tests passed');
          
        } catch (error) {
          console.error('âŒ Module test failed:', error.message);
          process.exit(1);
        }
        "

    - name: Run CI tests
      run: |
        echo "=== Running CI Test Suite ==="
        if [ -f "test-ci.js" ]; then
          node test-ci.js
        else
          echo "CI test file not found, skipping..."
        fi

  # é¡å¤–çš„ç·¨è­¯æ¸¬è©¦ï¼ˆå°ˆé–€æ¸¬è©¦ç·¨è­¯å•é¡Œï¼‰
  native-build-test:
    name: Native Build Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install system dependencies for build
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev

    - name: Install Node dependencies
      run: npm ci --prefer-offline

    - name: Full rebuild test
      run: |
        echo "=== Full Rebuild Test ==="
        npm run clean
        npm run rebuild

    - name: Verify native module
      run: |
        echo "=== Verify Native Module ==="
        ls -la build/Release/ 2>/dev/null || echo "Build directory not found"
        find build/ -name "*.node" -type f -exec file {} \; 2>/dev/null || echo "No .node files found"
        
        if [ -f "build/Release/XMRig.node" ]; then
          echo "âœ… Native module compiled successfully"
          # Test loading the native module
          node -e "
          try {
            const addon = require('./build/Release/XMRig.node');
            console.log('âœ… Native module loads successfully');
            console.log('Module exports:', Object.keys(addon));
          } catch (error) {
            console.error('âŒ Native module load failed:', error.message);
            process.exit(1);
          }
          "
        else
          echo "âŒ Native module compilation failed"
          exit 1
        fi

  # å®‰å…¨æ€§æª¢æŸ¥
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm ci --prefer-offline

    - name: Security audit
      run: |
        echo "=== Security Audit ==="
        npm audit --audit-level=moderate || echo "Audit completed with warnings"

    - name: License check
      run: |
        echo "=== License Check ==="
        if [ -f "LICENSE" ]; then
          echo "âœ… LICENSE file found"
        else
          echo "âš ï¸ LICENSE file not found"
        fi

    - name: Package metadata validation
      run: |
        echo "=== Package Validation ==="
        node -e "
        const pkg = require('./package.json');
        const required = ['name', 'version', 'main', 'description'];
        let missing = [];
        
        required.forEach(field => {
          if (!pkg[field]) missing.push(field);
        });
        
        if (missing.length > 0) {
          console.error('Missing required fields:', missing);
          process.exit(1);
        }
        
        console.log('âœ… Package metadata valid');
        console.log('Package:', pkg.name, '@', pkg.version);
        "

  # å…¼å®¹æ€§æ¸¬è©¦ï¼ˆè·¨ç‰ˆæœ¬ï¼‰
  compatibility-test:
    name: Compatibility Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['20.x', '22.x']

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: npm ci --prefer-offline

    - name: Quick compatibility test
      run: |
        echo "=== Compatibility Test - Node.js ${{ matrix.node-version }} ==="
        node -e "
        try {
          const XMRig = require('./index.js');
          
          // Test that all expected methods exist and work
          const result = {
            version: XMRig.getVersion(),
            algorithms: XMRig.getSupportedAlgorithms(),
            pools: XMRig.getRecommendedPools()
          };
          
          console.log('âœ… Compatibility test passed');
          console.log('Node.js version:', process.version);
          console.log('Module version:', result.version);
          console.log('Algorithms count:', result.algorithms.length);
          console.log('Pools count:', result.pools.length);
          
        } catch (error) {
          console.error('âŒ Compatibility test failed:', error.message);
          process.exit(1);
        }
        "

  # ç™¼ä½ˆæº–å‚™æª¢æŸ¥
  release-check:
    name: Release Preparation
    needs: [test-and-build, native-build-test, security-check, compatibility-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm ci

    - name: Release readiness check
      run: |
        echo "=== Release Readiness Check ==="
        echo "Checking all required files..."
        
        required_files=(
          "package.json"
          "README.md"
          "LICENSE"
          "index.js"
          "lib/xmrig.js"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
        echo "âœ… All required files present"

    - name: Generate release summary
      run: |
        echo "## ðŸ“¦ Release Summary - $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Core Platform Tests**: $(grep -c 'âœ…' job-summary-core.log 2>/dev/null || echo '0') passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Native Build**: Verified" >> $GITHUB_STEP_SUMMARY  
        echo "- **Security Audit**: Completed" >> $GITHUB_STEP_SUMMARY
        echo "- **Compatibility**: Cross-version tested" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Status" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Ready for release!" >> $GITHUB_STEP_SUMMARY