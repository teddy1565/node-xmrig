name: CI/CD Pipeline

on:
  push:
    branches: [ feat/rebuild ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-core:
    name: Test - ${{ matrix.os }} / Node.js ${{ matrix.node-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        # 簡化的測試矩陣，只測試核心平台
        - os: ubuntu-latest
          node-version: '20.x'
        - os: macos-latest
          node-version: '20.x'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: npm install
      continue-on-error: false

    - name: Display environment
      run: |
        echo "Environment: ${{ matrix.os }}"
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        echo "Platform: $(uname -a)"

    - name: Build check
      run: |
        echo "=== Build Check ==="
        npm run clean || true
        npm run build
      continue-on-error: true

    - name: Functionality test
      run: |
        echo "=== Functionality Test ==="
        node -e "
        const assert = require('assert');
        
        // Test basic module loading
        const XMRig = require('./index.js');
        console.log('✅ Module loaded');
        
        // Test basic API
        const version = XMRig.getVersion();
        assert.strictEqual(typeof version, 'string');
        assert.ok(version.length > 0);
        console.log('✅ Version API:', version);
        
        const algorithms = XMRig.getSupportedAlgorithms();
        assert.ok(Array.isArray(algorithms));
        assert.ok(algorithms.length > 0);
        console.log('✅ Algorithms:', algorithms.length);
        
        const pools = XMRig.getRecommendedPools();
        assert.ok(Array.isArray(pools));
        assert.ok(pools.length > 0);
        console.log('✅ Pools:', pools.length);
        
        // Test miner creation
        const config = {
          pool: {
            url: 'test.pool.com:5555',
            user: 'test_wallet_address_123456789abcdef',
            pass: 'x'
          },
          cpu: {
            threads: 2
          }
        };
        
        const miner = XMRig.createMiner(config);
        assert.ok(miner);
        assert.strictEqual(typeof miner.start, 'function');
        assert.strictEqual(typeof miner.stop, 'function');
        assert.strictEqual(typeof miner.getStats, 'function');
        assert.strictEqual(typeof miner.getStatus, 'function');
        console.log('✅ Miner creation and methods');
        
        // Test event system
        miner.on('test', () => {});
        miner.emit('test');
        console.log('✅ Event system');
        
        console.log('✅ All functionality tests passed');
        "

    - name: Run CI tests
      run: |
        echo "=== CI Test Suite ==="
        if [ -f "test-ci.js" ]; then
          node test-ci.js
        else
          echo "CI test file not found"
        fi

  native-compile:
    name: Native Compile - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        - os: ubuntu-latest
          node-version: '20.x'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install build dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y build-essential python3-dev

    - name: Install dependencies
      run: npm install

    - name: Clean and rebuild
      run: |
        echo "=== Native Build ==="
        npm run clean
        npm run build

    - name: Verify build artifacts
      run: |
        echo "=== Verify Build ==="
        ls -la build/Release/ 2>/dev/null || echo "No build directory"
        find build/ -name "*.node" 2>/dev/null || echo "No .node files"
        
        if [ -f "build/Release/XMRig.node" ]; then
          echo "✅ Native module compiled"
          file build/Release/XMRig.node
        else
          echo "❌ Native module not found"
          exit 1
        fi

    - name: Test native module
      run: |
        echo "=== Test Native Module ==="
        node -e "
        try {
          const addon = require('./build/Release/XMRig.node');
          console.log('✅ Native module loaded');
          console.log('Exports:', Object.keys(addon));
          
          if (typeof addon.getVersion === 'function') {
            console.log('✅ Native getVersion:', addon.getVersion());
          }
        } catch (error) {
          console.error('❌ Native module error:', error.message);
          process.exit(1);
        }
        "

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm install

    - name: Security audit
      run: |
        echo "=== Security Audit ==="
        npm audit --audit-level=moderate || echo "Audit completed"
        
    - name: Package validation
      run: |
        echo "=== Package Validation ==="
        node -e "
        const pkg = require('./package.json');
        console.log('Package:', pkg.name, '@', pkg.version);
        console.log('Main:', pkg.main);
        console.log('Engines:', pkg.engines?.node);
        console.log('✅ Package metadata valid');
        "