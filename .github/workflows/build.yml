name: Build and Test

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Build every day at 02:00 UTC
    - cron: '0 2 * * *'

jobs:
  # Test build on multiple platforms
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20, 22]
        include:
          # Add specific configurations for different platforms
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: win32
          - os: macos-latest
            platform: darwin
    
    name: Build on ${{ matrix.os }} (Node ${{ matrix.node-version }})
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev
        # Install additional tools for XMRig
        sudo apt-get install -y cmake ninja-build
    
    - name: Install system dependencies (macOS)
      if: matrix.platform == 'darwin'
      run: |
        # Install build tools via Homebrew
        brew install cmake ninja
        # Check if node-gyp prerequisites are installed
        python3 --version || brew install python3
        gcc --version || echo "GCC not found, will use Xcode compiler"
    
    - name: Install system dependencies (Windows)
      if: matrix.platform == 'win32'
      run: |
        # Install Visual Studio Build Tools and CMake
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
        choco install python3 --version 3.11.0
        # Note: Python installation for node-gyp
        echo "Python3 should be available at C:\\Python311\\python.exe"
    
    - name: Install npm dependencies
      run: |
        npm ci
        npm install -g node-gyp@latest
        
    - name: Clean previous builds
      run: |
        npm run clean 2>/dev/null || true
        rm -rf build/ || true
        rm -rf .node-gyp/ || true
        rm -rf node_modules/binding.gyp || true
    
    - name: Configure node-gyp
      run: |
        node-gyp configure --verbose
      env:
        npm_config_node_gyp: ./node_modules/node-gyp/bin/node-gyp.js
    
    - name: Build native addon
      run: |
        echo "Platform: ${{ matrix.platform }}"
        echo "Node version: $(node --version)"
        echo "npm version: $(npm --version)"
        
        # Set platform-specific flags
        if [ "${{ matrix.platform }}" = "linux" ]; then
          npm run build
        elif [ "${{ matrix.platform }}" = "win32" ]; then
          npm run build
        elif [ "${{ matrix.platform }}" = "darwin" ]; then
          # macOS specific build
          export MACOSX_DEPLOYMENT_TARGET=10.15
          npm run build
        fi
      env:
        npm_config_node_gyp: ./node_modules/node-gyp/bin/node-gyp.js
        npm_config_build_from_source: true
        npm_config_ignore_scripts: false
    
    - name: Check if build succeeded
      run: |
        if [ -f "./build/Release/XMRig.node" ]; then
          echo "‚úÖ Build successful - binary found"
          ls -la ./build/Release/
          file ./build/Release/XMRig.node
        else
          echo "‚ùå Build failed - binary not found"
          ls -la ./build/ 2>/dev/null || echo "Build directory not found"
          ls -la ./
          exit 1
        fi
    
    - name: Run basic test
      run: |
        node examples/test.js
      continue-on-error: true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: node-xmrig-${{ matrix.platform }}-node-${{ matrix.node-version }}
        path: |
          ./build/Release/XMRig.node
          ./build/Release/*.pdb
          ./package.json
        retention-days: 7

  # Test basic functionality
  test:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    
    name: Test on Node ${{ matrix.node-version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: node-xmrig-linux-node-${{ matrix.node-version }}
        path: ./build/
    
    - name: Run test suite
      run: |
        echo "Running test suite for Node.js ${{ matrix.node-version }}"
        node examples/test.js
      timeout-minutes: 5
    
    - name: Test basic miner creation
      run: |
        node -e "
        const { XMRig } = require('./index.js');
        console.log('Testing basic miner creation...');
        try {
          const miner = new XMRig({
            pool: {
              url: 'test.pool.com:5555',
              user: 'test_wallet_address'
            },
            cpu: {
              threads: 2
            }
          });
          const status = miner.getStatus();
          console.log('‚úÖ Miner creation successful');
          console.log('Status:', JSON.stringify(status, null, 2));
          miner.destroy();
        } catch (error) {
          console.error('‚ùå Miner creation failed:', error.message);
          process.exit(1);
        }
        "

  # Security scan
  security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
    
    - name: Run security audit
      run: |
        npm audit --audit-level moderate
      continue-on-error: true
    
    - name: Check for sensitive data
      run: |
        # Check for common sensitive patterns in code
        if grep -r "password\|secret\|key\|token" --include="*.js" --include="*.ts" --include="*.json" . | grep -v "example\|test\|config" | grep -v "package.json"; then
          echo "‚ö†Ô∏è Warning: Potential sensitive data found in source code"
          exit 1
        else
          echo "‚úÖ No sensitive data found in source code"
        fi

  # Performance test
  performance:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: node-xmrig-linux-node-20
        path: ./build/
    
    - name: Performance benchmark
      run: |
        node -e "
        console.log('Running performance benchmark...');
        const { XMRig } = require('./index.js');
        
        // Test different configurations
        const configs = [
          { threads: 1, name: '1 thread' },
          { threads: 2, name: '2 threads' },
          { threads: 4, name: '4 threads' }
        ];
        
        configs.forEach(config => {
          try {
            const startTime = Date.now();
            const miner = new XMRig({
              pool: { url: 'test.pool.com:5555', user: 'test' },
              cpu: { threads: config.threads }
            });
            const initTime = Date.now() - startTime;
            console.log(\`‚úÖ \${config.name}: Initialization time \${initTime}ms\`);
            
            const status = miner.getStatus();
            console.log(\`   Memory usage: \${status.memory || 'N/A'}\`);
            
            miner.destroy();
          } catch (error) {
            console.log(\`‚ùå \${config.name}: Failed - \${error.message}\`);
          }
        });
        "

  # Code quality check
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npm install -g eslint prettier jshint
    
    - name: Code style check
      run: |
        echo "Running code quality checks..."
        
        # Check JavaScript files for syntax errors
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./build/*" -exec jshint {} \; || echo "JSHint completed with warnings"
        
        # Check TypeScript definition file
        if [ -f "index.d.ts" ]; then
          echo "‚úÖ TypeScript definition file found"
          echo "File size: $(wc -l < index.d.ts) lines"
        fi
        
        # Check for TODO comments
        todo_count=$(grep -r "TODO\|FIXME" --include="*.js" --include="*.cc" --include="*.h" . | wc -l)
        echo "üìù Found $todo_count TODO/FIXME comments"
        
        # Check code documentation coverage
        doc_comments=$(grep -r "\/\*\*\|\/\*\|\/\/" --include="*.js" --include="*.cc" . | wc -l)
        total_lines=$(find . -name "*.js" -o -name "*.cc" | xargs wc -l | tail -1 | awk '{print $1}')
        echo "üìä Documentation: $doc_comments comment lines in $total_lines total lines"